blueprint:
  name: EV Charging Notification
  description: >
    Automatic updating notification about your EV charging status.
    Shows Charging Power (kW), Battery %, Estimated Finish Time while charging.
    Shows Fully Charged and Estimated Range when done.
    Converts Watts ➔ kW, and Range ➔ Miles or Kilometers.
    Supports mobile app notifications or sticky Home Assistant notifications.
    Adds dynamic icons (⚡ Charging / ✅ Fully Charged).
    Auto-clears notifications when unplugged.
  domain: automation
  input:
    charger_connection_status:
      name: Charger Connection Status Sensor
      description: Select the sensor showing whether the charger is connected.
      selector:
        entity:
          domain: sensor

    charging_power:
      name: Charging Power Sensor (Watts)
      description: Select the sensor that shows current charging power in Watts.
      selector:
        entity:
          domain: sensor

    battery_level:
      name: Battery Charge Level Sensor (%)
      description: Select the sensor showing the current battery percentage.
      selector:
        entity:
          domain: sensor

    estimated_finish_time:
      name: Estimated Finish Time Sensor
      description: Select the sensor showing the estimated fully charged time.
      selector:
        entity:
          domain: sensor

    range_km:
      name: Estimated Range Sensor (Kilometers)
      description: Select the sensor showing estimated driving range in kilometers.
      selector:
        entity:
          domain: sensor

    notify_devices:
      name: Mobile Devices (Optional)
      description: Select one or more devices to receive notifications. Leave blank to use a Home Assistant sticky notification.
      default: []
      selector:
        target:
          entity:
            domain: notify

    range_units:
      name: Preferred Distance Units
      description: Choose if you want the estimated range shown in miles or kilometers.
      default: miles
      selector:
        select:
          options:
            - miles
            - kilometers

trigger:
  - platform: state
    entity_id:
      - !input charger_connection_status
      - !input charging_power
      - !input battery_level
      - !input estimated_finish_time
      - !input range_km
    for:
      seconds: 30
  - platform: time_pattern
    minutes: "/2"  # Update every 2 minutes

variables:
  charging_power_kw: >
    {% set power = states(!input charging_power) | float(0) %}
    {{ (power / 1000) | round(1) }}
  battery_percent: >
    {{ states(!input battery_level) | float(0) | round(0) }}
  estimated_finish: >
    {{ states(!input estimated_finish_time) }}
  range_km_value: >
    {{ states(!input range_km) | float(0) }}
  range_value: >
    {% if iif('miles' == !input range_units, true, false) %}
      {{ (range_km_value * 0.621371) | round(0) }}
    {% else %}
      {{ range_km_value | round(0) }}
    {% endif %}
  range_unit_label: >
    {% if iif('miles' == !input range_units, true, false) %}
      miles
    {% else %}
      km
    {% endif %}
  notify_targets: >
    {{ expand(targets.notify_devices.entity_id) | map(attribute='entity_id') | list }}
  is_charging: >
    {{ states(!input charger_connection_status) == "Connected" and states(!input charging_power) | float(0) > 100 }}

condition: []

action:
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ is_charging }}"
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ notify_targets | length > 0 }}"
                sequence:
                  - service: notify.notify
                    data:
                      message: >
                        Estimated to finish at {{ estimated_finish }}
                      title: >
                        ⚡ Charging: {{ charging_power_kw }}kW at {{ battery_percent }}%
                      target: "{{ notify_targets }}"
              - default:
                  - service: persistent_notification.create
                    data:
                      title: >
                        ⚡ Charging: {{ charging_power_kw }}kW at {{ battery_percent }}%
                      message: >
                        Estimated to finish at {{ estimated_finish }}
                      notification_id: car_charging_status
      - conditions:
          - condition: template
            value_template: >
              {{ states(!input charger_connection_status) == "Connected" and states(!input charging_power) | float(0) <= 100 }}
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ notify_targets | length > 0 }}"
                sequence:
                  - service: notify.notify
                    data:
                      message: >
                        Estimated available range: {{ range_value }} {{ range_unit_label }}
                      title: >
                        ✅ Fully Charged: {{ battery_percent }}%
                      target: "{{ notify_targets }}"
              - default:
                  - service: persistent_notification.create
                    data:
                      title: >
                        ✅ Fully Charged: {{ battery_percent }}%
                      message: >
                        Estimated available range: {{ range_value }} {{ range_unit_label }}
                      notification_id: car_charging_status
      - conditions:
          - condition: template
            value_template: >
              {{ states(!input charger_connection_status) != "Connected" }}
        sequence:
          - service: persistent_notification.dismiss
            data:
              notification_id: car_charging_status

mode: single
