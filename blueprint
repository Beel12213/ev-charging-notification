blueprint:
  name: EV Charging Notification (Full Auto, Multi-Device, Dynamic Icons)
  description: >
    Automatic updating notification about your EV charging status.
    Supports dynamic icons (⚡ while charging, ✅ when fully charged).
    Converts Watts ➔ kW and Range ➔ Miles/KM.
    Sends notifications to multiple mobile devices.
    Auto-clears notification when car is unplugged.
  domain: automation
  input:
    charger_connection_status:
      name: Charger Connection Status Sensor
      description: >
        Select the sensor showing whether the charger is connected.
      selector:
        entity:
          domain: sensor

    charging_power:
      name: Charging Power Sensor (Watts)
      description: >
        Select the sensor that shows current charging power in Watts.
      selector:
        entity:
          domain: sensor

    battery_level:
      name: Battery Charge Level Sensor (%)
      description: >
        Select the sensor showing the current battery percentage.
      selector:
        entity:
          domain: sensor

    estimated_finish_time:
      name: Estimated Finish Time Sensor
      description: >
        Select the sensor showing the estimated fully charged time.
      selector:
        entity:
          domain: sensor

    range_km:
      name: Estimated Range Sensor (Kilometers)
      description: >
        Select the sensor showing estimated driving range in kilometers.
      selector:
        entity:
          domain: sensor

    notify_devices:
      name: Devices to Notify
      description: >
        Select one or more mobile devices that will receive notifications.
        Only devices using the Home Assistant Mobile App will appear here.
      default: []
      selector:
        device:
          filter:
            - integration: mobile_app
          multiple: true

    range_units:
      name: Preferred Distance Units
      description: >
        Choose if you want the estimated range shown in miles or kilometers.
      default: miles
      selector:
        select:
          options:
            - miles
            - kilometers

trigger:
  - platform: state
    entity_id:
      - !input charger_connection_status
      - !input charging_power
      - !input battery_level
      - !input estimated_finish_time
      - !input range_km
    for:
      seconds: 30
  - platform: time_pattern
    minutes: "/2"  # Update every 2 minutes

variables:
  charging_power_kw: >
    {% set power = states(!input charging_power) | float(0) %}
    {{ (power / 1000) | round(1) }}
  battery_percent: >
    {{ states(!input battery_level) | float(0) | round(0) }}
  estimated_finish: >
    {{ states(!input estimated_finish_time) }}
  range_km_value: >
    {{ states(!input range_km) | float(0) }}
  range_value: >
    {% if iif('miles' == !input range_units, true, false) %}
      {{ (range_km_value * 0.621371) | round(0) }}
    {% else %}
      {{ range_km_value | round(0) }}
    {% endif %}
  range_unit_label: >
    {% if iif('miles' == !input range_units, true, false) %}
      miles
    {% else %}
      km
    {% endif %}
  notify_services: >
    {{ expand(!input notify_devices) | map(attribute='entity_id') | select('search', '^notify\.') | list }}
  is_charging: >
    {{ states(!input charger_connection_status) == "Connected" and states(!input charging_power) | float(0) > 100 }}

condition: []

action:
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ is_charging }}"
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ notify_services | length > 0 }}"
                sequence:
                  - repeat:
                      for_each: "{{ notify_services }}"
                      sequence:
                        - service: "{{ repeat.item }}"
                          data:
                            title: >
                              ⚡ Charging: {{ charging_power_kw }}kW at {{ battery_percent }}%
                            message: >
                              Estimated to finish at {{ estimated_finish }}
              - default:
                  - service: persistent_notification.create
                    data:
                      title: >
                        ⚡ Charging: {{ charging_power_kw }}kW at {{ battery_percent }}%
                      message: >
                        Estimated to finish at {{ estimated_finish }}
                      notification_id: car_charging_status
      - conditions:
          - condition: template
            value_template: >
              {{ states(!input charger_connection_status) == "Connected" and states(!input charging_power) | float(0) <= 100 }}
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ notify_services | length > 0 }}"
                sequence:
                  - repeat:
                      for_each: "{{ notify_services }}"
                      sequence:
                        - service: "{{ repeat.item }}"
                          data:
                            title: >
                              ✅ Fully Charged: {{ battery_percent }}%
                            message: >
                              Estimated available range: {{ range_value }} {{ range_unit_label }}
              - default:
                  - service: persistent_notification.create
                    data:
                      title: >
                        ✅ Fully Charged: {{ battery_percent }}%
                      message: >
                        Estimated available range: {{ range_value }} {{ range_unit_label }}
                      notification_id: car_charging_status
      - conditions:
          - condition: template
            value_template: >
              {{ states(!input charger_connection_status) != "Connected" }}
        sequence:
          - service: persistent_notification.dismiss
            data:
              notification_id: car_charging_status

mode: single
